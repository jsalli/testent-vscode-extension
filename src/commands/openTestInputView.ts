import { TestableFunction } from '@testent/shared-code-processing';
import { TextDocumentShowOptions, window, workspace } from 'vscode';
import { JsTsLanguageHandler } from '../languageHandlers/javascriptTypescript/JsTsLanguageHandler';
import { Logger } from '../logger';
import { TestCase } from '../types/types';
import { Command, command, Commands } from './common';

export interface OpenTestInputViewArgs {
	testableFunction: TestableFunction;
	showOptions?: TextDocumentShowOptions;
}

export type OpenTestInputViewReturn = void;

@command()
export class OpenTestInputViewCommand extends Command {
	constructor() {
		super(Commands.OpenTestInputView);
	}

	public override dispose(): void {
		super.dispose();
	}

	public async execute(
		args: OpenTestInputViewArgs,
	): Promise<OpenTestInputViewReturn> {
		try {
			if (
				JsTsLanguageHandler.languageIdIsTypeScript(
					args.testableFunction.languageId,
				) ||
				JsTsLanguageHandler.languageIdIsJavaScript(
					args.testableFunction.languageId,
				)
			) {
				const { testCases: existingTestCases, languageId: existingLanguageId } =
					this.readExistingInputs(args.testableFunction.testFilePath);
				if (
					existingLanguageId &&
					existingLanguageId !== args.testableFunction.languageId
				) {
					const message = `Existing tests ("${existingLanguageId}") are different language than the source file language ("${args.testableFunction.languageId}")`;
					Logger.error(message);
					throw new Error(message);
				}

				const viewContent = JsTsLanguageHandler.createInputViewContent(
					args.testableFunction,
					// args.testableFunction.id,
					'test',
					existingTestCases,
				);

				const document = await workspace.openTextDocument({
					language: args.testableFunction.languageId,
					content: viewContent,
				});

				const showOptions = args.showOptions;
				await window.showTextDocument(document, showOptions);
			}
			// else if (languageId === 'Python') {
			//   Handle Python stuff
			// }
			else {
				throw new Error(
					`Unsupported languageId: "${args.testableFunction.languageId}" for opening test input view`,
				);
			}
		} catch (error) {
			const logMessage = 'Error opening Test Input View';
			Logger.error(error, logMessage);
			let errorToThrow: Error;
			if (PRODUCTION === false) {
				errorToThrow = error;
			} else {
				errorToThrow = new Error(logMessage);
			}
			throw errorToThrow;
		}
	}

	/**
	 * Parse existing test files and get inputs which they are using
	 *
	 * @param testFilePath
	 * @returns
	 */
	private readExistingInputs(testFilePath: string | undefined): {
		testCases: TestCase[] | undefined;
		languageId: string | undefined;
	} {
		if (testFilePath === undefined) {
			return { testCases: undefined, languageId: undefined };
		}
		//TODO: Read the test file and return real stuff
		return { testCases: undefined, languageId: undefined };
	}
}
